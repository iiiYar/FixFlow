{% extends "layout.html" %}
{% block content %}
<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- كارد البحث -->
        <div class="col-12">
            <div class="card search-card">
                <div class="card-header bg-primary">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-search me-2"></i>
                        البحث وتصفية النتائج
                    </h5>
                </div>
                <div class="card-body py-4">
                    <div class="row gy-3">
                        <!-- حقل البحث -->
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" 
                                       id="searchInput" 
                                       class="form-control" 
                                       placeholder="ابحث عن (اسم العميل، رقم الهاتف، نوع الجهاز، المشكلة)..."
                                       aria-label="Search repairs">
                            </div>
                        </div>
                        <!-- قائمة التصفية -->
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-filter"></i>
                                </span>
                                <select id="statusFilter" class="form-select" onchange="loadRepairs()">
                                    <option value="">جميع الحالات</option>
                                    <option value="قيد الانتظار">قيد الانتظار</option>
                                    <option value="جاري الصيانة">جاري الصيانة</option>
                                    <option value="تم الإصلاح">تم الإصلاح</option>
                                    <option value="تم التسليم">تم التسليم</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card repair-form-card h-100">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    إضافة طلب صيانة
                </h5>
            </div>
            <div class="card-body">
                <form id="repairForm">
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-user me-1"></i>
                            العميل
                        </label>
                        <div class="input-group">
                            <select class="form-select custom-select" name="customer_id" required>
                                <option value="">اختر العميل</option>
                            </select>
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-mobile-alt me-1"></i>
                            نوع الجهاز
                        </label>
                        <input type="text" class="form-control custom-input" name="device_type" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-wrench me-1"></i>
                            المشكلة
                        </label>
                        <textarea class="form-control custom-textarea" name="problem" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-money-bill-wave me-1"></i>
                            التكلفة
                        </label>
                        <div class="input-group">
                            <input type="number" class="form-control custom-input" name="cost" required>
                            <span class="input-group-text">ريال</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-tasks me-1"></i>
                            حالة الصيانة
                        </label>
                        <select class="form-select custom-select" name="status" required>
                            <option value="قيد الانتظار">قيد الانتظار</option>
                            <option value="جاري الصيانة">جاري الصيانة</option>
                            <option value="تم الإصلاح">تم الإصلاح</option>
                            <option value="تم التسليم">تم التسليم</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-calendar me-1"></i>
                            التاريخ
                        </label>
                        <div class="input-group">
                            <input type="date" class="form-control custom-input" name="date" id="repairDate">
                            <button type="button" class="btn btn-outline-secondary" onclick="setCurrentDate()">
                                <i class="fas fa-clock"></i>
                                التاريخ الحالي
                            </button>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus-circle me-1"></i>
                        إضافة طلب
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card repairs-table-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-tools me-2"></i>
                    طلبات الصيانة
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle" id="repairsTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="id">رقم الطلب</th>
                                <th class="sortable" data-sort="customer_name">اسم العميل</th>
                                <th class="sortable" data-sort="customer_phone">رقم الهاتف</th>
                                <th class="sortable" data-sort="device_type">نوع الجهاز</th>
                                <th class="sortable" data-sort="problem">المشكلة</th>
                                <th class="sortable" data-sort="cost">التكلفة</th>
                                <th class="sortable" data-sort="status">الحالة</th>
                                <th class="sortable" data-sort="date">التاريخ</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="repairsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal إضافة عميل جديد -->
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCustomerModalLabel">إضافة عميل جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCustomerForm">
                    <div class="mb-3">
                        <label class="form-label">الاسم</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">رقم الهاتف</label>
                        <input type="text" class="form-control" name="phone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">جهة العمل (اختياري)</label>
                        <input type="text" class="form-control" name="workplace">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="addNewCustomer()">إضافة</button>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --primary-color: #1a73e8;
    --primary-dark: #1557b0;
    --primary-light: #e8f0fe;
    --secondary-color: #5f6368;
    --success-color: #28a745;
    --warning-color: #ffc107;
    --danger-color: #dc3545;
    --background-primary: #ffffff;
    --background-secondary: #f8f9fa;
    --text-primary: #202124;
    --text-secondary: #5f6368;
    --border-color: #dadce0;
}

.search-card {
    border: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.search-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.search-card .card-header {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    padding: 1rem 1.5rem;
    border-bottom: none;
}

.search-card .card-body {
    padding: 1.5rem;
    background-color: var(--background-primary);
}

.search-group .input-group {
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

.search-group .input-group-text {
    background-color: var(--background-primary);
    border-right: none;
}

.search-group .form-control {
    border-left: none;
    padding-left: 0;
}

.search-group .form-control:focus {
    box-shadow: none;
    border-color: var(--border-color);
}

.filter-group .form-select {
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 8px;
    border: 1px solid var(--border-color);
    padding: 0.6rem 1rem;
}

.btn-group {
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 8px;
    overflow: hidden;
}

.btn-refresh {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-refresh:hover {
    background-color: var(--primary-dark);
    border-color: var(--primary-dark);
}

.btn-auto-refresh {
    border-color: var(--primary-color);
    color: var(--primary-color);
}

.btn-auto-refresh:hover {
    background-color: var(--primary-light);
}

.btn-auto-refresh.active {
    background-color: var(--success-color);
    border-color: var(--success-color);
    color: white;
}

.form-label {
    color: var(--text-secondary);
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-label i {
    color: var(--primary-color);
}

.custom-input:focus, .custom-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(26, 115, 232, 0.15);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.search-card {
    animation: fadeIn 0.3s ease-out;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    display: inline-block;
}

.status-pending {
    background-color: rgba(242, 153, 0, 0.1);
    color: var(--pending-color);
}

.status-in-progress {
    background-color: rgba(26, 115, 232, 0.1);
    color: var(--in-progress-color);
}

.status-completed {
    background-color: rgba(24, 128, 56, 0.1);
    color: var(--completed-color);
}

.status-delivered {
    background-color: rgba(95, 99, 104, 0.1);
    color: var(--delivered-color);
}

.toast-notification {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 20px;
    border-radius: 4px;
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.fa-spin {
    animation: fa-spin 1s infinite linear;
}

@keyframes fa-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* الألوان الأساسية */
:root {
    --primary-color: #1a73e8;
    --primary-dark: #1557b0;
    --primary-light: #e8f0fe;
    --secondary-color: #5f6368;
    --background-primary: #ffffff;
    --background-secondary: #f8f9fa;
    --border-color: #dadce0;
}

/* تصميم الكارد */
.search-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.search-card .card-header {
    border-radius: 12px 12px 0 0;
    padding: 1.25rem;
}

.search-card .card-body {
    background-color: var(--background-primary);
}

/* تصميم حقل البحث */
.search-group .input-group {
    border-radius: 8px;
    overflow: hidden;
    background: var(--background-secondary);
}

.search-group .input-group-text,
.search-group .form-control {
    background: transparent;
}

.search-group .form-control:focus {
    background: white;
}

/* تصميم قائمة التصفية */
.filter-group .form-select {
    border-radius: 8px;
    background-color: var(--background-secondary);
    height: 42px;
}

/* تصميم الأزرار */
.action-group .btn {
    height: 42px;
    border-radius: 8px;
}

/* تنسيق العناوين */
.form-label {
    color: var(--secondary-color);
    font-weight: 500;
}

.form-label i {
    color: var(--primary-color);
}

/* تأثيرات التفاعل */
.form-control:focus,
.form-select:focus {
    box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
}

.btn:focus {
    box-shadow: none;
}

/* تحسين التجاوب */
@media (max-width: 768px) {
    .action-group {
        margin-top: 1rem;
    }
}

.sortable {
    cursor: pointer;
    user-select: none;
}

.sortable:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.sortable::after {
    content: '↕️';
    margin-right: 5px;
    opacity: 0.3;
}

.sortable.asc::after {
    content: '↑';
    opacity: 1;
}

.sortable.desc::after {
    content: '↓';
    opacity: 1;
}
</style>

<script>
    let searchTimeout;
    let autoRefreshInterval;
    let isAutoRefreshEnabled = false;

    function loadRepairs() {
        const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const refreshIcon = document.querySelector('.fa-sync-alt');
        
        if (refreshIcon) {
            refreshIcon.classList.add('fa-spin');
        }
        
        const searchParams = new URLSearchParams();
        if (searchQuery) searchParams.append('search', searchQuery);
        if (statusFilter) searchParams.append('status', statusFilter);
        
        fetch(`/api/repairs?${searchParams.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.querySelector('#repairsTable tbody');
                tbody.innerHTML = '';
                
                let filteredData = data.filter(repair => {
                    const searchTerms = searchQuery.split(' ');
                    return searchTerms.every(term => 
                        (repair.customer_name && repair.customer_name.toLowerCase().includes(term)) ||
                        (repair.customer_phone && repair.customer_phone.toLowerCase().includes(term)) ||
                        (repair.device_type && repair.device_type.toLowerCase().includes(term)) ||
                        (repair.problem && repair.problem.toLowerCase().includes(term)) ||
                        (repair.id && repair.id.toString().includes(term))
                    );
                });

                // ترتيب البيانات حسب التاريخ تنازلياً
                filteredData = sortData(filteredData, 'date');
                
                if (filteredData.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="text-center py-4 text-muted">
                                <i class="fas fa-search fa-2x mb-3 d-block"></i>
                                لا توجد نتائج تطابق البحث
                            </td>
                        </tr>
                    `;
                    return;
                }

                // تجميع الطلبات حسب اليوم
                const groupedByDate = {};
                filteredData.forEach(repair => {
                    const date = new Date(repair.date);
                    const dateStr = date.toLocaleDateString('en-GB', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    
                    if (!groupedByDate[dateStr]) {
                        groupedByDate[dateStr] = [];
                    }
                    groupedByDate[dateStr].push(repair);
                });

                // عرض الطلبات مجمعة حسب اليوم
                Object.entries(groupedByDate).forEach(([dateStr, repairs]) => {
                    // إضافة عنوان اليوم
                    const dateHeader = document.createElement('tr');
                    dateHeader.className = 'table-light';
                    dateHeader.innerHTML = `
                        <td colspan="9" class="fw-bold py-3">
                            <i class="fas fa-calendar-day me-2"></i>
                            طلبات يوم ${dateStr}
                            <span class="badge bg-primary ms-2">${repairs.length} طلب</span>
                        </td>
                    `;
                    tbody.appendChild(dateHeader);

                    // عرض طلبات هذا اليوم
                    repairs.forEach(repair => {
                        const safeHtml = {
                            id: repair.id,
                            customer_name: repair.customer_name ? repair.customer_name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '',
                            customer_phone: repair.customer_phone ? repair.customer_phone.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '',
                            device_type: repair.device_type ? repair.device_type.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '',
                            problem: repair.problem ? repair.problem.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '',
                            cost: parseFloat(repair.cost || 0).toLocaleString('ar-SA'),
                            status: repair.status
                        };

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${safeHtml.id}</td>
                            <td>${safeHtml.customer_name}</td>
                            <td>${safeHtml.customer_phone || ''}</td>
                            <td>${safeHtml.device_type}</td>
                            <td>${safeHtml.problem}</td>
                            <td>${safeHtml.cost} ريال</td>
                            <td class="status-cell"></td>
                            <td dir="ltr">${dateStr}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteRepair(${safeHtml.id})">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        
                        const statusCell = tr.querySelector('.status-cell');
                        statusCell.appendChild(createStatusSelect(repair.id, repair.status));
                        
                        tbody.appendChild(tr);
                    });
                });
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'حدث خطأ في تحميل البيانات');
            })
            .finally(() => {
                if (refreshIcon) {
                    refreshIcon.classList.remove('fa-spin');
                }
            });
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    document.getElementById('searchInput').addEventListener('input', debounce(() => {
        const searchIcon = document.querySelector('.fa-search');
        if (searchIcon) {
            searchIcon.classList.add('fa-spin');
            setTimeout(() => searchIcon.classList.remove('fa-spin'), 500);
        }
        loadRepairs();
    }, 500));

    document.getElementById('statusFilter').addEventListener('change', () => {
        loadRepairs();
    });

    async function loadCustomers() {
        const response = await fetch('/api/customers');
        const customers = await response.json();
        const select = document.querySelector('select[name="customer_id"]');
        select.innerHTML = '<option value="">اختر العميل</option>';
        customers.forEach(customer => {
            select.innerHTML += `<option value="${customer.id}">${customer.name} - ${customer.phone}</option>`;
        });
    }

    async function updateStatus(repairId, currentStatus) {
        try {
            const response = await fetch(`/api/repairs/${repairId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: currentStatus })
            });
            
            if (response.ok) {
                showToast('success', 'تم تحديث حالة الطلب بنجاح');
                loadRepairs();
            } else {
                showToast('error', 'حدث خطأ أثناء تحديث حالة الطلب');
            }
        } catch (error) {
            console.error('Error updating status:', error);
            showToast('error', 'حدث خطأ أثناء تحديث الحالة');
        }
    }

    function createStatusSelect(repairId, currentStatus) {
        const statuses = [
            { value: 'قيد الانتظار', label: 'قيد الانتظار', color: 'warning' },
            { value: 'جاري الصيانة', label: 'جاري الصيانة', color: 'info' },
            { value: 'تم الإصلاح', label: 'تم الإصلاح', color: 'success' },
            { value: 'تم التسليم', label: 'تم التسليم', color: 'primary' }
        ];

        const select = document.createElement('select');
        select.className = 'form-select form-select-sm status-select';
        select.onchange = () => updateStatus(repairId, select.value);

        statuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status.value;
            option.textContent = status.label;
            if (status.value === currentStatus) {
                option.selected = true;
                select.className += ` text-${status.color}`;
            }
            select.appendChild(option);
        });

        // إضافة مستمع لتغيير لون النص عند تغيير الحالة
        select.addEventListener('change', function() {
            // إزالة جميع فئات الألوان السابقة
            this.className = this.className.replace(/text-\w+/, '');
            // إضافة اللون الجديد
            const selectedStatus = statuses.find(s => s.value === this.value);
            if (selectedStatus) {
                this.className += ` text-${selectedStatus.color}`;
            }
        });

        return select;
    }

    async function updateStatus(repairId, newStatus) {
        try {
            const response = await fetch(`/api/repairs/${repairId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            });

            if (!response.ok) {
                throw new Error('Failed to update status');
            }

            const statusLabels = {
                'قيد الانتظار': 'قيد الانتظار',
                'جاري الصيانة': 'جاري الصيانة',
                'تم الإصلاح': 'تم الإصلاح',
                'تم التسليم': 'تم التسليم'
            };

            showToast('success', `تم تحديث حالة الطلب إلى ${statusLabels[newStatus]}`);
            
            // تحديث لون الخلية حسب الحالة الجديدة
            const statusColors = {
                'قيد الانتظار': 'warning',
                'جاري الصيانة': 'info',
                'تم الإصلاح': 'success',
                'تم التسليم': 'primary'
            };
            
            const select = document.querySelector(`select[data-repair-id="${repairId}"]`);
            if (select) {
                select.className = select.className.replace(/text-\w+/, '');
                select.className += ` text-${statusColors[newStatus]}`;
            }
        } catch (error) {
            console.error('Error updating status:', error);
            showToast('error', 'حدث خطأ أثناء تحديث الحالة');
        }
    }

    function setCurrentDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        document.getElementById('repairDate').value = `${year}-${month}-${day}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        setCurrentDate();
    });

    document.getElementById('repairForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
            customer_id: formData.get('customer_id'),
            device_type: formData.get('device_type'),
            problem: formData.get('problem'),
            cost: formData.get('cost'),
            date: formData.get('date') || new Date().toISOString().split('T')[0], // استخدام التاريخ الحالي إذا لم يتم تحديد تاريخ
            status: formData.get('status') // الحالة الافتراضية هي قيد الانتظار
        };

        try {
            const response = await fetch('/api/repairs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                e.target.reset();
                setCurrentDate(); // إعادة تعيين التاريخ الحالي بعد إعادة تعيين النموذج
                showToast('success', 'تم إضافة طلب الصيانة بنجاح');
                loadRepairs();
            } else {
                showToast('error', 'حدث خطأ أثناء إضافة طلب الصيانة');
            }
        } catch (error) {
            console.error('Error:', error);
            showToast('error', 'حدث خطأ في النظام');
        }
    });

    async function deleteRepair(repairId) {
        if (confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
            await fetch(`/api/repairs/${repairId}`, {
                method: 'DELETE'
            });
            loadRepairs();
        }
    }

    async function addNewCustomer() {
        const form = document.getElementById('addCustomerForm');
        const formData = new FormData(form);
        const data = {
            name: formData.get('name'),
            phone: formData.get('phone'),
            workplace: formData.get('workplace') || null
        };
        
        try {
            const response = await fetch('/api/customers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                // إغلاق النافذة المنبثقة
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCustomerModal'));
                modal.hide();
                
                // إعادة تعيين النموذج
                form.reset();
                
                // تحديث قائمة العملاء
                await loadCustomers();
                
                // عرض رسالة نجاح
                alert('تم إضافة العميل بنجاح');
            } else {
                alert('حدث خطأ أثناء إضافة العميل');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('حدث خطأ أثناء إضافة العميل');
        }
    }

    function showToast(type, message) {
        const toastTypes = {
            success: { icon: 'fas fa-check-circle', color: '#28a745' },
            error: { icon: 'fas fa-exclamation-circle', color: '#dc3545' },
            info: { icon: 'fas fa-info-circle', color: '#17a2b8' }
        };
        
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.innerHTML = `
            <i class="${toastTypes[type].icon}"></i>
            <span>${message}</span>
        `;
        toast.style.backgroundColor = toastTypes[type].color;
        
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }

    function toggleAutoRefresh() {
        isAutoRefreshEnabled = !isAutoRefreshEnabled;
        const btn = document.getElementById('autoRefreshBtn');
        const text = document.getElementById('autoRefreshText');
        
        if (isAutoRefreshEnabled) {
            autoRefreshInterval = setInterval(loadRepairs, 30000); // تحديث كل 30 ثانية
            btn.classList.remove('btn-outline-primary');
            btn.classList.add('btn-success');
            text.textContent = 'إيقاف التحديث التلقائي';
            showToast('success', 'تم تفعيل التحديث التلقائي');
        } else {
            clearInterval(autoRefreshInterval);
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
            text.textContent = 'تفعيل التحديث التلقائي';
            showToast('info', 'تم إيقاف التحديث التلقائي');
        }
    }

    let currentSort = {
        column: 'date',
        direction: 'desc'
    };

    function compareValues(a, b, column) {
        if (column === 'cost') {
            return parseFloat(a[column] || 0) - parseFloat(b[column] || 0);
        }
        if (column === 'date') {
            return new Date(b.date) - new Date(a.date); // ترتيب تنازلي للتاريخ
        }
        if (column === 'id') {
            return parseInt(a[column]) - parseInt(b[column]);
        }
        
        const valueA = (a[column] || '').toString().toLowerCase();
        const valueB = (b[column] || '').toString().toLowerCase();
        return valueA.localeCompare(valueB, 'ar');
    }

    function sortData(data, column) {
        if (currentSort.column === column) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = column;
            currentSort.direction = 'asc';
        }

        document.querySelectorAll('th.sortable').forEach(th => {
            th.classList.remove('asc', 'desc');
            if (th.dataset.sort === column) {
                th.classList.add(currentSort.direction);
            }
        });

        return [...data].sort((a, b) => {
            const comparison = compareValues(a, b, column);
            return currentSort.direction === 'asc' ? comparison : -comparison;
        });
    }

    document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            loadRepairs();
        });
    });

    loadCustomers();
    loadRepairs();
</script>
{% endblock %}
