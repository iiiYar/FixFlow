from flask import Flask, render_template, request, jsonify
from flask_sqlalchemy import SQLAlchemy
from datetime import datetime, date, timedelta
import os
from sqlalchemy import func
from collections import defaultdict
import json
from werkzeug.utils import secure_filename
import requests
from functools import wraps
from flask import session, redirect, url_for
from flask_migrate import Migrate

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql+pymysql://fixflowuser:fixflowpassword@db/fixflowdb'
app.secret_key = 'your-secret-key-here'  # ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
db = SQLAlchemy(app)
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
migrate = Migrate(app, db)

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
USERS = {
    'admin': {
        'password': 'admin123',
        'role': 'admin'
    }
}

# Models
class Customer(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(100), nullable=False)
    phone = db.Column(db.String(20), nullable=False)
    workplace = db.Column(db.String(100), nullable=True)  # Ø­Ù‚Ù„ Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ø®ØªÙŠØ§Ø±ÙŠ
    repairs = db.relationship('Repair', backref='customer', lazy=True)

    def to_dict(self):
        return {
            'id': self.id,
            'name': self.name,
            'phone': self.phone,
            'workplace': self.workplace
        }

class Repair(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    customer_id = db.Column(db.Integer, db.ForeignKey('customer.id'), nullable=False)
    device_type = db.Column(db.String(100), nullable=False)
    problem = db.Column(db.Text, nullable=False)
    cost = db.Column(db.Float, nullable=False)
    status = db.Column(db.String(50), default='Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±')  # Ø§Ù„Ø­Ø§Ù„Ø§Øª: Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©ØŒ ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ØŒ ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…
    date = db.Column(db.DateTime, default=datetime.utcnow)

    def to_dict(self):
        return {
            'id': self.id,
            'customer_id': self.customer_id,
            'device_type': self.device_type,
            'problem': self.problem,
            'cost': self.cost,
            'status': self.status,
            'date': self.date
        }

class NotificationLog(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(200), nullable=False)
    description = db.Column(db.Text, nullable=False)
    type = db.Column(db.String(50), nullable=False)  # Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± (Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ØŒ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø©ØŒ Ø§Ù„Ø®)
    status = db.Column(db.String(50), nullable=False)  # Ù†Ø¬Ø§Ø­ Ø£Ùˆ ÙØ´Ù„
    timestamp = db.Column(db.DateTime, default=datetime.utcnow)
    
    def to_dict(self):
        return {
            'id': self.id,
            'title': self.title,
            'description': self.description,
            'type': self.type,
            'status': self.status,
            'timestamp': self.timestamp.strftime('%Y-%m-%d %H:%M:%S')
        }

# Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
def init_db():
    with app.app_context():
        # Create the database directory if it doesn't exist
        db_dir = os.path.dirname(app.config['SQLALCHEMY_DATABASE_URI'].replace('mysql+pymysql://', ''))
        if db_dir and not os.path.exists(db_dir):
            os.makedirs(db_dir)
        
        # Create tables if they don't exist
        db.create_all()
        
        # Print all table names for debugging
        print("Tables in the database:")
        for table in db.engine.table_names():
            print(table)

# Initialize database on startup
init_db()

# ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Discord
CONFIG_FILE = 'config.json'

def load_config():
    try:
        if os.path.exists(CONFIG_FILE):
            with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                return json.load(f)
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: {e}")
    return {"discord_webhook_url": "", "notifications_enabled": True}

def save_config(config):
    try:
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, ensure_ascii=False, indent=4)
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: {e}")

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
config = load_config()
discord_webhook_url = config.get('discord_webhook_url', '')
notifications_enabled = config.get('notifications_enabled', True)

def send_discord_notification(title, description, notification_type, color=0x00ff00):
    """Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ Discord ÙˆØªØ³Ø¬ÙŠÙ„Ù‡"""
    status = 'Ù†Ø¬Ø§Ø­'
    
    try:
        print(f"Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±: {title}")
        print(f"Webhook URL: {discord_webhook_url}")
        print(f"Notifications Enabled: {notifications_enabled}")
        
        if notifications_enabled and discord_webhook_url:
            data = {
                "embeds": [{
                    "title": title.encode('utf-8').decode('utf-8'),
                    "description": description.encode('utf-8').decode('utf-8'),
                    "color": color,
                    "timestamp": datetime.utcnow().isoformat()
                }]
            }
            response = requests.post(discord_webhook_url, json=data)
            print(f"Response Status Code: {response.status_code}")
            
            if response.status_code != 204:
                status = 'ÙØ´Ù„'
                print(f"ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: {response.text}")
        else:
            status = 'Ù…Ø¹Ø·Ù„'
            print("Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ø¹Ø·Ù„Ø©")
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Discord: {e}")
        status = 'ÙØ´Ù„'
    
    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
    log = NotificationLog(
        title=title.encode('utf-8').decode('utf-8'),
        description=description.encode('utf-8').decode('utf-8'),
        type=notification_type,
        status=status
    )
    db.session.add(log)
    db.session.commit()
    print(f"ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: {title} - Ø§Ù„Ø­Ø§Ù„Ø©: {status}")

# Authentication decorator
def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)
    return decorated_function

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
app.config['SESSION_COOKIE_SECURE'] = False  # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø¹Ù„Ù‰ HTTP Ùˆ HTTPS
app.config['REMEMBER_COOKIE_SECURE'] = False  # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙƒÙˆÙƒÙŠØ² ØªØ°ÙƒØ± Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ HTTP Ùˆ HTTPS
app.config['SESSION_COOKIE_HTTPONLY'] = True  # Ù…Ù†Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒÙˆÙƒÙŠØ² Ø¹Ø¨Ø± JavaScript
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(minutes=30)  # Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© 30 Ø¯Ù‚ÙŠÙ‚Ø©

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª URL
app.config['PREFERRED_URL_SCHEME'] = 'https'  # ØªÙØ¶ÙŠÙ„ HTTPS ÙˆÙ„ÙƒÙ† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ HTTP

# Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ Ù„Ù€ HTTPS
# @app.before_request
# def before_request():
#     if not request.is_secure and app.env != 'development':
#         url = request.url.replace('http://', 'https://', 1)
#         return redirect(url, code=301)

@app.route('/login', methods=['GET'])
def login():
    if 'user' in session:
        return redirect(url_for('repairs_page'))
    return render_template('login.html')

@app.route('/api/login', methods=['POST'])
def api_login():
    data = request.get_json()
    username = data.get('username')
    password = data.get('password')
    
    if username in USERS and USERS[username]['password'] == password:
        session['user'] = {
            'username': username,
            'role': USERS[username]['role']
        }
        return jsonify({
            'success': True,
            'redirect': url_for('repairs_page')
        })
    
    return jsonify({
        'success': False,
        'message': 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©'
    }), 401

@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('login'))

# Routes
@app.route('/')
@login_required
def index():
    return render_template('dashboard.html')

@app.route('/customers')
@login_required
def customers_page():
    return render_template('customers.html')

@app.route('/repairs')
@login_required
def repairs_page():
    return render_template('repairs.html')

@app.route('/repair/<int:repair_id>')
@login_required
def repair_details(repair_id):
    repair = Repair.query.get_or_404(repair_id)
    return render_template('repair_details.html', repair=repair)

@app.route('/api/customers', methods=['GET', 'POST'])
@login_required
def customers():
    if request.method == 'POST':
        data = request.json
        customer = Customer(
            name=data['name'],
            phone=data['phone'],
            workplace=data.get('workplace')  # Ø§Ø³ØªØ®Ø¯Ø§Ù… get Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ù‚Ù„
        )
        db.session.add(customer)
        db.session.commit()
        send_discord_notification(
            "ğŸ‘¤ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯",
            f"ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯:\nØ§Ù„Ø§Ø³Ù…: {customer.name}\nØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: {customer.phone}",
            'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯'
        )
        return jsonify({'message': 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'id': customer.id})
    
    customers = Customer.query.all()
    return jsonify([{
        'id': c.id,
        'name': c.name,
        'phone': c.phone,
        'workplace': c.workplace,
        'repairs_count': len(c.repairs)
    } for c in customers])

@app.route('/api/customers/<int:customer_id>', methods=['DELETE'])
@login_required
def delete_customer(customer_id):
    customer = Customer.query.get_or_404(customer_id)
    name = customer.name  # Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
    db.session.delete(customer)
    db.session.commit()
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø­Ø°Ù Ø¹Ù…ÙŠÙ„
    send_discord_notification(
        "âŒ Ø­Ø°Ù Ø¹Ù…ÙŠÙ„",
        f"ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„:\nØ§Ù„Ø§Ø³Ù…: {name}",
        'Ø­Ø°Ù Ø¹Ù…ÙŠÙ„',
        color=0xff0000
    )
    return jsonify({'message': 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­'})

@app.route('/api/repairs', methods=['GET', 'POST'])
@login_required
def repairs():
    if request.method == 'POST':
        data = request.json
        try:
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©
            if not all(key in data for key in ['customer_id', 'device_type', 'problem', 'cost']):
                return jsonify({'error': 'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©'}), 400
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù‚ÙŠÙ…
            customer_id = int(data['customer_id'])
            device_type = str(data['device_type']).strip()
            problem = str(data['problem']).strip()
            cost = float(data['cost'])
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
            customer = Customer.query.get(customer_id)
            if not customer:
                return jsonify({'error': 'Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}), 404
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù‚ÙŠÙ…
            if not device_type or not problem:
                return jsonify({'error': 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙˆØ§Ù„Ù…Ø´ÙƒÙ„Ø©'}), 400
            
            if cost < 0:
                return jsonify({'error': 'Ø§Ù„ØªÙƒÙ„ÙØ© ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø±Ù‚Ù…Ù‹Ø§ Ù…ÙˆØ¬Ø¨Ù‹Ø§'}), 400
            
            repair = Repair(
                customer_id=customer_id,
                device_type=device_type,
                problem=problem,
                cost=cost,
                date=datetime.utcnow(),  # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­
                status='Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'  # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            )
            db.session.add(repair)
            db.session.commit()
        
            # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯
            send_discord_notification(
                "ğŸ”§ Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯",
                f"ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯:\nØ§Ù„Ø¹Ù…ÙŠÙ„: {customer.name}\nÙ†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²: {repair.device_type}\nØ§Ù„Ù…Ø´ÙƒÙ„Ø©: {repair.problem}\nØ§Ù„ØªÙƒÙ„ÙØ©: {repair.cost}",
                'Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø© Ø¬Ø¯ÙŠØ¯',
                color=0x0000ff
            )
            return jsonify({'message': 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', 'repair_id': repair.id}), 201
        
        except (ValueError, TypeError) as e:
            db.session.rollback()
            return jsonify({'error': 'Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + str(e)}), 400
        
        except Exception as e:
            db.session.rollback()
            return jsonify({'error': 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ' + str(e)}), 500
    
    status = request.args.get('status')
    search_query = request.args.get('q', '').strip()
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    query = db.session.query(Repair).join(Customer)
    
    # ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ø°Ø§ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡
    if status:
        query = query.filter(Repair.status == status)
            
    # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø« Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø«
    if search_query:
        search_filter = db.or_(
            Customer.name.ilike(f'%{search_query}%'),
            Customer.phone.ilike(f'%{search_query}%'),
            Repair.device_type.ilike(f'%{search_query}%'),
            Repair.problem.ilike(f'%{search_query}%')
        )
        query = query.filter(search_filter)
        
    repairs = query.order_by(Repair.date.desc()).all()
    return jsonify([{
        'id': repair.id,
        'customer_name': repair.customer.name,
        'customer_phone': repair.customer.phone,
        'device_type': repair.device_type,
        'problem': repair.problem,
        'cost': repair.cost,
        'status': repair.status,
        'date': repair.date.strftime('%Y-%m-%d %H:%M')
    } for repair in repairs])

@app.route('/api/repairs/<int:repair_id>', methods=['DELETE'])
@login_required
def delete_repair(repair_id):
    repair = Repair.query.get_or_404(repair_id)
    customer = repair.customer  # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
    device = repair.device_type  # Ø­ÙØ¸ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù
    db.session.delete(repair)
    db.session.commit()
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ Ø­Ø°Ù Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©
    send_discord_notification(
        "âŒ Ø­Ø°Ù Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©",
        f"ØªÙ… Ø­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©:\nØ§Ù„Ø¹Ù…ÙŠÙ„: {customer.name}\nÙ†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²: {device}",
        'Ø­Ø°Ù Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©',
        color=0xff0000
    )
    return jsonify({'message': 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­'})

@app.route('/api/repairs/<int:repair_id>', methods=['PUT'])
@login_required
def update_repair(repair_id):
    repair = Repair.query.get_or_404(repair_id)
    data = request.json
    
    if 'device_type' in data:
        repair.device_type = data['device_type']
    if 'problem' in data:
        repair.problem = data['problem']
    if 'cost' in data:
        repair.cost = float(data['cost'])
    
    db.session.commit()
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©
    changes = []
    if 'device_type' in data:
        changes.append(f"Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²: {repair.device_type}")
    if 'problem' in data:
        changes.append(f"Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: {repair.problem}")
    if 'cost' in data:
        changes.append(f"Ø§Ù„ØªÙƒÙ„ÙØ©: {repair.cost}")
    
    if changes:
        send_discord_notification(
            "ğŸ“ ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©",
            f"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©:\nØ§Ù„Ø¹Ù…ÙŠÙ„: {repair.customer.name}\n" + "\n".join(changes),
            'ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©',
            color=0xffa500
        )
    
    return jsonify({'message': 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­'})

@app.route('/api/repairs/<int:repair_id>/status', methods=['PUT'])
@login_required
def update_repair_status(repair_id):
    data = request.json
    repair = Repair.query.get_or_404(repair_id)
    old_status = repair.status
    repair.status = data['status']
    db.session.commit()
    
    status_colors = {
        'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±': 0xffa500,  # Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
        'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©': 0x0000ff,  # Ø£Ø²Ø±Ù‚
        'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­': 0x00ff00,    # Ø£Ø®Ø¶Ø±
        'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…': 0x4b0082     # Ø¨Ù†ÙØ³Ø¬ÙŠ
    }
    
    send_discord_notification(
        "ğŸ”§ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©",
        f"ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©:\nØ±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: {repair_id}\nØ§Ù„Ø­Ø§Ù„Ø©: {old_status} â¡ï¸ {repair.status}",
        'ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©',
        color=status_colors.get(repair.status, 0x00ff00)
    )
    
    return jsonify({'message': 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­'})

@app.route('/api/stats')
@login_required
def get_stats():
    today = date.today()
    
    total_customers = Customer.query.count()
    active_repairs = Repair.query.filter(Repair.status != 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…').count()
    today_repairs = Repair.query.filter(
        func.date(Repair.date) == today
    ).count()
    total_revenue = db.session.query(db.func.sum(Repair.cost)).scalar() or 0
    
    latest_repairs = Repair.query.order_by(Repair.date.desc()).limit(5).all()
    latest_repairs_data = [{
        'customer_name': r.customer.name,
        'device_type': r.device_type,
        'status': r.status,
        'date': r.date.strftime('%Y-%m-%d')
    } for r in latest_repairs]
    
    status_stats = {}
    for repair in Repair.query.all():
        status_stats[repair.status] = status_stats.get(repair.status, 0) + 1
    
    return jsonify({
        'total_customers': total_customers,
        'active_repairs': active_repairs,
        'today_repairs': today_repairs,
        'total_revenue': total_revenue,
        'latest_repairs': latest_repairs_data,
        'status_stats': status_stats
    })

@app.route('/api/stats/revenue')
@login_required
def get_revenue_stats():
    # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©
    status_revenue = db.session.query(
        Repair.status,
        db.func.sum(Repair.cost).label('total'),
        db.func.count(Repair.id).label('count')
    ).group_by(Repair.status).all()
    
    # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø©
    today = datetime.now().date()
    week_ago = today - timedelta(days=7)
    month_ago = today - timedelta(days=30)
    
    daily_revenue = db.session.query(
        func.date(Repair.date).label('date'),
        db.func.sum(Repair.cost).label('total'),
        Repair.status,
        db.func.count(Repair.id).label('count')
    ).group_by(db.func.date(Repair.date), Repair.status)\
    .order_by(db.func.date(Repair.date).desc())\
    .limit(7).all()
    
    weekly_revenue = db.session.query(
        func.strftime('%Y-%W', Repair.date).label('week'),
        db.func.sum(Repair.cost).label('total'),
        Repair.status,
        db.func.count(Repair.id).label('count')
    ).group_by(db.func.strftime('%Y-%W', Repair.date), Repair.status)\
    .order_by(db.func.strftime('%Y-%W', Repair.date).desc())\
    .limit(4).all()
    
    monthly_revenue = db.session.query(
        func.strftime('%Y-%m', Repair.date).label('month'),
        db.func.sum(Repair.cost).label('total'),
        Repair.status,
        db.func.count(Repair.id).label('count')
    ).group_by(db.func.strftime('%Y-%m', Repair.date), Repair.status)\
    .order_by(db.func.strftime('%Y-%m', Repair.date).desc())\
    .limit(6).all()
    
    return jsonify({
        'status': [{
            'status': r.status,
            'total': float(r.total),
            'count': r.count
        } for r in status_revenue],
        'daily': [{
            'date': str(r.date),
            'total': float(r.total),
            'status': r.status,
            'count': r.count
        } for r in daily_revenue],
        'weekly': [{
            'week': r.week,
            'total': float(r.total),
            'status': r.status,
            'count': r.count
        } for r in weekly_revenue],
        'monthly': [{
            'month': r.month,
            'total': float(r.total),
            'status': r.status,
            'count': r.count
        } for r in monthly_revenue]
    })

@app.route('/api/stats/devices')
@login_required
def get_device_stats():
    # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
    top_devices = db.session.query(
        Repair.device_type,
        db.func.count(Repair.id).label('count'),
        db.func.sum(Repair.cost).label('total_revenue')
    ).group_by(Repair.device_type)\
    .order_by(db.func.count(Repair.id).desc())\
    .limit(5).all()
    
    return jsonify([{
        'device_type': d.device_type,
        'count': d.count,
        'total_revenue': float(d.total_revenue)
    } for d in top_devices])

@app.route('/api/stats/customers/details')
@login_required
def get_customer_details():
    today = datetime.now().date()
    start_of_month = today.replace(day=1)
    
    new_today = Customer.query.filter(func.date(Customer.created_at) == today).count()
    new_this_month = Customer.query.filter(
        func.date(Customer.created_at) >= start_of_month,
        func.date(Customer.created_at) <= today
    ).count()
    active_customers = Customer.query.filter(Customer.is_active == True).count()
    
    return jsonify({
        'new_today': new_today,
        'new_this_month': new_this_month,
        'active_customers': active_customers
    })

@app.route('/api/stats/repairs/details')
@login_required
def get_repair_details():
    today = datetime.now().date()
    
    in_progress = Repair.query.filter(Repair.status == 'in_progress').count()
    pending = Repair.query.filter(Repair.status == 'pending').count()
    completed_today = Repair.query.filter(
        func.date(Repair.completion_date) == today,
        Repair.status == 'completed'
    ).count()
    new_today = Repair.query.filter(
        func.date(Repair.created_at) == today
    ).count()
    
    return jsonify({
        'in_progress': in_progress,
        'pending': pending,
        'completed_today': completed_today,
        'new_today': new_today
    })

@app.route('/api/stats/revenue/details')
@login_required
def get_revenue_details():
    today = datetime.now().date()
    start_of_month = today.replace(day=1)
    
    today_revenue = db.session.query(func.sum(Repair.cost)).filter(
        func.date(Repair.completion_date) == today,
        Repair.status == 'completed'
    ).scalar() or 0
    
    month_revenue = db.session.query(func.sum(Repair.cost)).filter(
        func.date(Repair.completion_date) >= start_of_month,
        func.date(Repair.completion_date) <= today,
        Repair.status == 'completed'
    ).scalar() or 0
    
    avg_repair_cost = db.session.query(func.avg(Repair.cost)).filter(
        Repair.status == 'completed'
    ).scalar() or 0
    
    return jsonify({
        'today_revenue': today_revenue,
        'month_revenue': month_revenue,
        'avg_repair_cost': round(avg_repair_cost, 2)
    })

@app.route('/api/dashboard/stats')
@login_required
def get_dashboard_stats():
    try:
        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        total_customers = Customer.query.count()
        
        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª
        total_repairs = Repair.query.count()
        active_repairs = Repair.query.filter(Repair.status.in_(['Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©'])).count()
        
        # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
        today = datetime.now().date()
        today_repairs = Repair.query.filter(
            func.date(Repair.date) == today
        ).count()
        
        # Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
        completed_repairs = Repair.query.filter_by(status='ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­').all()
        total_revenue = sum(repair.cost for repair in completed_repairs if repair.cost)
        
        return jsonify({
            'total_customers': total_customers,
            'total_repairs': total_repairs,
            'active_repairs': active_repairs,
            'today_repairs': today_repairs,
            'total_revenue': total_revenue
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/dashboard/repair-stats')
@login_required
def get_repair_stats():
    try:
        repairs = Repair.query.all()
        stats = {
            'ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­': 0,
            'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…': 0,
            'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©': 0,
            'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±': 0
        }
        
        for repair in repairs:
            if repair.status in stats:
                stats[repair.status] += 1
        
        return jsonify(stats)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/dashboard/revenue')
@login_required
def get_revenue_data():
    try:
        period = request.args.get('period', 'daily')
        status = request.args.get('status', None)  # Ø¥Ø¶Ø§ÙØ© ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
        today = datetime.now().date()
        
        if period == 'daily':
            # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            start_date = today - timedelta(days=6)
            query = Repair.query.filter(func.date(Repair.date) >= start_date)
            
            if status:
                query = query.filter(Repair.status == status)
            
            repairs = query.all()
            
            daily_revenue = defaultdict(lambda: {'total': 0.0, 'count': 0})
            for repair in repairs:
                date_str = repair.date.strftime('%Y-%m-%d')
                daily_revenue[date_str]['total'] += repair.cost or 0
                daily_revenue[date_str]['count'] += 1
            
            # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            days_arabic = ['Ø§Ù„Ø³Ø¨Øª', 'Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', 'Ø§Ù„Ø®Ù…ÙŠØ³', 'Ø§Ù„Ø¬Ù…Ø¹Ø©']
            labels = []
            data = []
            counts = []
            
            for i in range(7):
                date = start_date + timedelta(days=i)
                date_str = date.strftime('%Y-%m-%d')
                labels.append(days_arabic[date.weekday()])
                data.append(daily_revenue[date_str]['total'])
                counts.append(daily_revenue[date_str]['count'])
            
        elif period == 'weekly':
            # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            start_date = today - timedelta(weeks=4)
            query = Repair.query.filter(func.date(Repair.date) >= start_date)
            
            if status:
                query = query.filter(Repair.status == status)
            
            repairs = query.all()
            
            weekly_revenue = defaultdict(lambda: {'total': 0.0, 'count': 0})
            for repair in repairs:
                week = repair.date.strftime('%Y-%W')
                weekly_revenue[week]['total'] += repair.cost or 0
                weekly_revenue[week]['count'] += 1
            
            labels = ['Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ' + str(i+1) for i in range(4)]
            data = []
            counts = []
            
            current_week = datetime.now().strftime('%Y-%W')
            for i in range(4):
                week = (datetime.now() - timedelta(weeks=i)).strftime('%Y-%W')
                data.append(weekly_revenue[week]['total'])
                counts.append(weekly_revenue[week]['count'])
            
            # Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„ÙŠÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
            labels.reverse()
            data.reverse()
            counts.reverse()
            
        elif period == 'monthly':
            # Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ø³ØªØ© Ø£Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠØ©
            start_date = today - timedelta(days=180)
            query = Repair.query.filter(func.date(Repair.date) >= start_date)
            
            if status:
                query = query.filter(Repair.status == status)
            
            repairs = query.all()
            
            monthly_revenue = defaultdict(lambda: {'total': 0.0, 'count': 0})
            for repair in repairs:
                month = repair.date.strftime('%Y-%m')
                monthly_revenue[month]['total'] += repair.cost or 0
                monthly_revenue[month]['count'] += 1
            
            # Ø§Ù„Ø£Ø´Ù‡Ø± Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            months_arabic = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø¥Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                           'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±']
            
            labels = []
            data = []
            counts = []
            
            for i in range(6):
                date = today - timedelta(days=30*i)
                month = date.strftime('%Y-%m')
                labels.append(months_arabic[date.month - 1])
                data.append(monthly_revenue[month]['total'])
                counts.append(monthly_revenue[month]['count'])
            
            # Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨ Ù„ÙŠÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
            labels.reverse()
            data.reverse()
            counts.reverse()
        
        return jsonify({
            'labels': labels,
            'data': data,
            'counts': counts,
            'period': period,
            'status': status
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/dashboard/recent-repairs')
@login_required
def get_recent_repairs():
    try:
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± 10 Ø·Ù„Ø¨Ø§Øª ØµÙŠØ§Ù†Ø©
        recent_repairs = Repair.query.order_by(Repair.date.desc()).limit(10).all()
        
        repairs_list = []
        for repair in recent_repairs:
            repairs_list.append({
                'customer_name': repair.customer.name,
                'device_type': repair.device_type,
                'problem': repair.problem,
                'status': repair.status,
                'date': repair.date.strftime('%Y-%m-%d %H:%M'),
                'cost': repair.cost
            })
        
        return jsonify(repairs_list)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/notifications/log')
@login_required
def notifications_log():
    """ØµÙØ­Ø© Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"""
    page = request.args.get('page', 1, type=int)
    per_page = 20
    
    logs = NotificationLog.query.order_by(NotificationLog.timestamp.desc()).paginate(
        page=page, per_page=per_page, error_out=False)
    
    return render_template('notifications_log.html', logs=logs)

@app.route('/api/notifications/stats')
@login_required
def get_notifications_stats():
    """Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"""
    from sqlalchemy import func
    
    # Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    total_notifications = NotificationLog.query.count()
    
    # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
    status_stats = db.session.query(
        NotificationLog.status, 
        func.count(NotificationLog.id)
    ).group_by(NotificationLog.status).all()
    
    status_dict = {status: count for status, count in status_stats}
    
    # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    type_stats = db.session.query(
        NotificationLog.type, 
        func.count(NotificationLog.id)
    ).group_by(NotificationLog.type).all()
    
    type_dict = {type_name: count for type_name, count in type_stats}
    
    # Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙŠÙˆÙ…ÙŠØ©
    daily_stats = db.session.query(
        func.date(NotificationLog.timestamp).label('date'), 
        func.count(NotificationLog.id)
    ).group_by('date').order_by('date').all()
    
    daily_dict = {str(date): count for date, count in daily_stats}
    
    return jsonify({
        'total': total_notifications,
        'by_status': status_dict,
        'by_type': type_dict,
        'daily': daily_dict
    })

# Ù…Ø³Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
@app.route('/settings')
@login_required
def settings():
    return render_template('settings.html')

# API Ù„Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
@app.route('/api/settings', methods=['GET', 'POST'])
@login_required
def handle_settings():
    if request.method == 'POST':
        # Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        settings_data = request.json
        try:
            # ÙŠÙ…ÙƒÙ†Ùƒ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§
            return jsonify({'success': True})
        except Exception as e:
            return jsonify({'success': False, 'error': str(e)})
    else:
        # Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        settings = {
            'darkMode': False,
            'notifications': True,
            'paperSize': 'A4',
            'printLogo': True,
            'companyName': 'Ù…Ø±ÙƒØ² Ø§Ù„ØµÙŠØ§Ù†Ø©',
            'phone': '0512345678',
            'address': 'Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©'
        }
        return jsonify(settings)

@app.route('/api/database/export')
@login_required
def export_database():
    try:
        # Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
        data = {
            'customers': [customer.to_dict() for customer in Customer.query.all()],
            'repairs': [repair.to_dict() for repair in Repair.query.all()]
        }
        
        # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ù†Øµ
        for repair in data['repairs']:
            if repair.get('date'):
                repair['date'] = repair['date'].strftime('%Y-%m-%d %H:%M:%S')
        
        return jsonify(data)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/api/database/import', methods=['POST'])
@login_required
def import_database():
    try:
        if 'file' not in request.files:
            return jsonify({'success': False, 'error': 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù'}), 400
            
        file = request.files['file']
        if file.filename == '':
            return jsonify({'success': False, 'error': 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ù„Ù'}), 400
            
        if not file.filename.endswith('.json'):
            return jsonify({'success': False, 'error': 'ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù Ø¨ØµÙŠØºØ© JSON'}), 400
            
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù
        data = json.loads(file.read())
        
        try:
            # Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            Repair.query.delete()
            Customer.query.delete()
            NotificationLog.query.delete()
            db.session.commit()
            
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
            for customer_data in data.get('customers', []):
                customer = Customer(
                    name=customer_data['name'],
                    phone=customer_data.get('phone'),
                    workplace=customer_data.get('workplace')
                )
                db.session.add(customer)
            
            db.session.commit()  # Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù€ IDs
            
            # Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©
            for repair_data in data.get('repairs', []):
                date = datetime.strptime(repair_data['date'], '%Y-%m-%d %H:%M:%S') if repair_data.get('date') else None
                repair = Repair(
                    customer_id=repair_data['customer_id'],
                    device_type=repair_data['device_type'],
                    problem=repair_data['problem'],
                    cost=repair_data.get('cost'),
                    status=repair_data.get('status', 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'),
                    date=date
                )
                db.session.add(repair)
            
            db.session.commit()
            return jsonify({'success': True})
            
        except Exception as e:
            db.session.rollback()
            raise e
            
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500

# Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø±Ø§Øª API Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
@app.route('/api/user/current')
@login_required
def get_current_user():
    return jsonify({
        'username': session['user']['username'],
        'role': session['user']['role']
    })

@app.route('/api/users')
@login_required
def get_users():
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ù…Ø¯ÙŠØ±
    if session['user']['role'] != 'admin':
        return jsonify({'error': 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„'}), 403
    
    return jsonify([{
        'username': username,
        'role': user_data['role']
    } for username, user_data in USERS.items()])

@app.route('/api/user/password', methods=['POST'])
@login_required
def change_password():
    data = request.get_json()
    new_password = data.get('newPassword')
    username = session['user']['username']
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·ÙˆÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    if len(new_password) < 6:
        return jsonify({
            'success': False,
            'message': 'ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'
        }), 400
    
    # ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    USERS[username]['password'] = new_password
    
    return jsonify({
        'success': True,
        'message': 'ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­'
    })

@app.route('/api/user/reset-password', methods=['POST'])
@login_required
def reset_user_password():
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ù…Ø¯ÙŠØ±
    if session['user']['role'] != 'admin':
        return jsonify({'error': 'ØºÙŠØ± Ù…ØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„ÙˆØµÙˆÙ„'}), 403
    
    data = request.get_json()
    username = data.get('username')
    
    if username not in USERS:
        return jsonify({
            'success': False,
            'message': 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'
        }), 404
    
    # Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
    import random
    import string
    new_password = ''.join(random.choices(string.ascii_letters + string.digits, k=8))
    
    # ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
    USERS[username]['password'] = new_password
    
    return jsonify({
        'success': True,
        'newPassword': new_password,
        'message': 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­'
    })

@app.route('/accounts')
@login_required
def accounts_page():
    return render_template('accounts.html')

if __name__ == '__main__':
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ°ÙŠÙ† 80 (HTTP) Ùˆ 443 (HTTPS)
    from werkzeug.serving import run_simple
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø´Ù‡Ø§Ø¯Ø§Øª SSL
    ssl_context = None
    if os.environ.get('FLASK_ENV') == 'production' and os.path.exists('cert.pem') and os.path.exists('key.pem'):
        ssl_context = ('cert.pem', 'key.pem')
    
    # ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    if os.environ.get('FLASK_ENV') == 'production':
        # ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¥Ù†ØªØ§Ø¬ØŒ Ø§Ø³ØªØ®Ø¯Ù… gunicorn
        from gunicorn.app.base import BaseApplication

        class FlaskApplication(BaseApplication):
            def __init__(self, app, options=None):
                self.options = options or {}
                self.application = app
                super().__init__()

            def load_config(self):
                for key, value in self.options.items():
                    self.cfg.set(key, value)

            def load(self):
                return self.application

        options = {
            'bind': ['0.0.0.0:80', '0.0.0.0:443'],
            'workers': 4,
            'certfile': 'cert.pem' if ssl_context else None,
            'keyfile': 'key.pem' if ssl_context else None
        }
        
        FlaskApplication(app, options).run()
    else:
        # ÙÙŠ Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø®Ø§Ø¯Ù… Flask Ø§Ù„Ù…Ø¯Ù…Ø¬
        app.run(host='0.0.0.0', port=5000, debug=True)
